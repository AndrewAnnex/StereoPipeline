name: ssh
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    - name: Download artifacts from previous run
      uses: actions/download-artifact@v3
      with: 
         ## Download the artifacts from the previous run. The name must be the
         ## same as at the end where the artifacts are uploaded. The path will
         ## be the same one as in the upload step, that is:
         ## ~/work/StereoPipeline/packages
         name: ssh-test-${{ runner.os }}
    - name: Cache conda
      id: cache-conda
      uses: actions/cache@v3
      env:
        cache-name: cache-conda
      with:
        ## Cache the ASP dependencies. They will be created manually in the next
        ## step, after logging with ssh, and the actual caching will happen when
        ## this recipe exits. Changes to the cache cannot be saved, so it should
        ## be wiped from the web interface before starting this workflow, if
        ## desired to recreate it.
        path: |
          /usr/local/miniconda/envs
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/miniconda.json') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ env.cache-name }}-
          ${{ runner.os }}-build-
          ${{ runner.os }}-
    - name: Setup tmate session
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to-actor: true
        ##limit-access-to-users: oleg-alexandrov
        ## If no one connects after 5 minutes, shut down the server
        ##wait-timeout-minutes: 5
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with: 
         ## Useful for saving any results produced in this session
         ## We will download this artifact in the next run.
         name: ssh-test-${{ runner.os }}
         path: ~/work/StereoPipeline/packages
         retention-days: 2
